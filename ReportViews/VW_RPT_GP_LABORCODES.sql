/* GP_LABORCODES
--GP Labor Codes Summary EXCEL
--GP Labor Codes by Dept EXCEL
SELECT 
* 
FROM VW_RPT_GP_LABORCODES (NOLOCK)

--MACRO-------------
WHERE WAREHOUSEID = '60' 
--AND JOBCODE = '1000' 
AND FISCALYEAR = 2023
AND CHECKDATE <= '2023-05-05 00:00:00.000'
AND (	CHECKDATE >= '2023-04-29 00:00:00.000' 
		OR ISYTD = 'Y')
ORDER BY
	COMPANYID, 
	WAREHOUSEID, 
	JOBCODE,
	DEPARTMENT, 
	CHECKDATE, 
	ISYTD 
*/

CREATE OR ALTER   VIEW [dbo].[VW_RPT_GP_LABORCODES] 
AS 
SELECT 
	WH.COMPANYID, 
	WH.IDENTITYID AS WAREHOUSEID, 
	WH.NAME AS WAREHOUSENAME, 
	X.DEPRTMNT AS DEPARTMENT, 
	X.DEPTDESC AS DEPARTMENTDESC, 
	X.JOBTITLE AS JOBCODE, 
	X.JOBDESC AS JOBCODEDESC, 
	DATEPART(YEAR, DATEADD(month,4,X.CHECKDATE)) AS FISCALYEAR, 
	X.CHECKDATE, 
	X.ISYTD, 
	SUM(X.CURR_HOURS) AS HOURS, 
	SUM(X.CURR_DOLLARS) AS DOLLARS, 
	SUM(X.CURR_YTD_HOURS) AS YTDHOURS, 
	SUM(X.CURR_YTD_DOLLARS) AS YTDDOLLARS, 
	SUM(X.PREV_YTD_HOURS) AS PRIORYTDHOURS, 
	SUM(X.PREV_YTD_DOLLARS) AS PRIORYTDDOLLARS, 
	SUM(X.CURR_YTD_HOURS - X.PREV_YTD_HOURS) AS CHANGEHOURS, 
	SUM(X.CURR_YTD_DOLLARS - X.PREV_YTD_DOLLARS) AS CHANGEDOLLARS, 
	X.PYRLRTYP AS PRTYPE, 
	X.PAYROLCD AS PRCODE 
FROM ( 
		--CURRENT DAILY TOTALS 
		SELECT 
			CD.CHEKDATE AS CHECKDATE, 
			'N' AS ISYTD, 
			CD.UNTSTOPY AS CURR_HOURS, 
			CD.UPRTRXAM AS CURR_DOLLARS, 
			0 AS CURR_YTD_HOURS, 
			0 AS CURR_YTD_DOLLARS, 
			0 AS PREV_YTD_HOURS, 
			0 AS PREV_YTD_DOLLARS, 
			* 
		FROM [GNCGPDB\GP2018].PROD.DBO.v_GNC_ProjectReportByDeptWithContractLabor CD (NOLOCK) 
		--FROM [GNCGPDB\GP2018].PROD.DBO.v_GNC_ProjectReportByDeptWithContractLabor800days CD (NOLOCK) 
		UNION ALL 
		--CURRENT YTD TOTALS 
		SELECT 
			CY.CHEKDATE AS CHECKDATE, 
			'Y' AS ISYTD, 
			0 AS CURR_HOURS, 
			0 AS CURR_DOLLARS, 
			CY.UNTSTOPY AS CURR_YTD_HOURS, 
			CY.UPRTRXAM AS CURR_YTD_DOLLARS, 
			0 AS PREV_YTD_HOURS, 
			0 AS PREV_YTD_DOLLARS, 
			* 
		FROM [GNCGPDB\GP2018].PROD.DBO.v_GNC_ProjectReportByDeptWithContractLabor CY (NOLOCK) 
		--FROM [GNCGPDB\GP2018].PROD.DBO.v_GNC_ProjectReportByDeptWithContractLabor800days CY (NOLOCK) 
		UNION ALL 
		--PREVIOUS YTD TOTALS 
		SELECT 
			DBO.FN_DATE4NEXTYEAR(PY.CHEKDATE) AS CHECKDATE, 
			'Y' AS ISYTD, 
			0 AS CURR_HOURS, 
			0 AS CURR_DOLLARS, 
			0 AS CURR_YTD_HOURS, 
			0 AS CURR_YTD_DOLLARS, 
			PY.UNTSTOPY AS PREV_YTD_HOURS, 
			PY.UPRTRXAM AS PREV_YTD_DOLLARS, 
			* 
		FROM [GNCGPDB\GP2018].PROD.DBO.v_GNC_ProjectReportByDeptWithContractLabor PY (NOLOCK) 
		--FROM [GNCGPDB\GP2018].PROD.DBO.v_GNC_ProjectReportByDeptWithContractLabor800days PY (NOLOCK) 
) X 
--JOIN IDMASTER WH (NOLOCK) ON WH.IDENTITYID = IIF(LEFT(X.DEPRTMNT,1)='3', '60', LEFT(X.DEPRTMNT,1)+'0') 
JOIN IDMASTER WH (NOLOCK) ON WH.IDENTITYID = WAREHOUSE 
GROUP BY 
	WH.COMPANYID, 	WH.IDENTITYID, WH.NAME, 
	X.DEPRTMNT, 	X.DEPTDESC, 
	X.JOBTITLE, 	X.JOBDESC, 
	X.CHECKDATE, 	X.ISYTD, 
	X.PYRLRTYP, 	X.PAYROLCD 

/*
	SELECT DISTINCT DEPRTMNT, WH.IDENTITYID AS WAREHOUSEID, WH.NAME AS WAREHOUSENAME
	--IIF(LEFT(DEPRTMNT,1)='3', '60', LEFT(DEPRTMNT,1)+'0') AS WAREHOUSEID
	FROM	[GNCGPDB\GP2018].[PROD].[DBO].[UPR30300] X 
	LEFT JOIN IDMASTER WH (NOLOCK) ON WH.IDENTITYID = IIF(LEFT(X.DEPRTMNT,1)='3', '60', LEFT(X.DEPRTMNT,1)+'0')
	ORDER BY X.DEPRTMNT
*/
/*
--MY CONVERTED SCRIPT--*NOT USING*
SELECT	UPR30300.CHEKDATE, UPR30300.DEPRTMNT, UPR30300.JOBTITLE, UPR30300.UNTSTOPY, UPR30300.UPRTRXAM, 
		UPR40301.DSCRIPTN JOBDESC, UPR30300.PYRLRTYP, UPR30300.PAYROLCD, UPR40300.DSCRIPTN DEPTDESC
FROM	[GNCGPDB\GP2018].PROD.DBO.UPR30300 UPR30300 
		JOIN [GNCGPDB\GP2018].PROD.DBO.UPR40301 UPR40301 ON UPR30300.JOBTITLE=UPR40301.JOBTITLE
		JOIN [GNCGPDB\GP2018].PROD.DBO.UPR40300 UPR40300 ON UPR30300.DEPRTMNT=UPR40300.DEPRTMNT
WHERE  UPR30300.PYRLRTYP=1 
AND UPR30300.JOBTITLE NOT IN (	'12702', '12703', '60201', '60201C', '60202', '60300', '60300F', '80100', '80500', '81000', 
								'83001', '83002', '83500', '90101', '90101P', '90101T', '90102', '90203', '90203F', '90203P'
								) 
AND UPR30300.PAYROLCD NOT IN ('LIFE', 'VEHICL') 

UNION ALL 

SELECT	CLP.CHEKDATE, CLP.DPRTMNT DEPTDESC, CLP.JOBTITLE , CLP.UNTSTOPY, CLP.UPRTRXAM, 
		UPR40301.DSCRIPTN JOBDESC, CLP.PYRLRTYP, CLP.PAYROLCD, UPR40300.DSCRIPTN DEPTDESC
FROM	[GNCGPDB\GP2018].PROD.DBO.ContractLaborPay CLP
		JOIN [GNCGPDB\GP2018].PROD.DBO.UPR40301 UPR40301 ON CLP.JOBTITLE = UPR40301.JOBTITLE) 
		JOIN [GNCGPDB\GP2018].PROD.DBO.UPR40300 UPR40300 ON CLP.DPRTMNT = UPR40300.DEPRTMNT
WHERE	CLP.PYRLRTYP=1 
AND		CLP.JOBTITLE NOT IN (	'12702', '12703', '60201', '60201C', '60202', '60300', '60300F', '80100', '80500', '81000', 
								'83001', '83002', '83500', '90101', '90101P', '90101T', '90102', '90203', '90203F', '90203P'
								) 
AND		CLP.PAYROLCD NOT IN ('LIFE', 'VEHICL') 


--JOANNE SCRIPT--
ALTER VIEW [dbo].[v_GNC_ProjectReportByDeptWithContractLabor]
AS
SELECT UPR30300.CHEKDATE, UPR30300.DEPRTMNT, UPR30300.JOBTITLE, UPR30300.UNTSTOPY, UPR30300.UPRTRXAM, UPR40301.DSCRIPTN JOBDESC, UPR30300.PYRLRTYP, UPR30300.PAYROLCD, UPR40300.DSCRIPTN DEPTDESC
FROM   (PROD.dbo.UPR30300 UPR30300 INNER JOIN PROD.dbo.UPR40301 UPR40301 ON UPR30300.JOBTITLE=UPR40301.JOBTITLE) 
                                    INNER JOIN PROD.dbo.UPR40300 UPR40300 ON UPR30300.DEPRTMNT=UPR40300.DEPRTMNT
WHERE  UPR30300.PYRLRTYP=1 
 AND NOT (UPR30300.JOBTITLE='12702' 
 OR UPR30300.JOBTITLE='12703' 
 OR UPR30300.JOBTITLE='60201' 
 OR UPR30300.JOBTITLE='60201C' 
 OR UPR30300.JOBTITLE='60202' 
 OR UPR30300.JOBTITLE='60300' 
 OR UPR30300.JOBTITLE='60300F' 
 OR UPR30300.JOBTITLE='80100' 
 OR UPR30300.JOBTITLE='80500' 
 OR UPR30300.JOBTITLE='81000' 
 OR UPR30300.JOBTITLE='83001' 
 OR UPR30300.JOBTITLE='83002' 
 OR UPR30300.JOBTITLE='83500' 
 OR UPR30300.JOBTITLE='90101' 
 OR UPR30300.JOBTITLE='90101P' 
 OR UPR30300.JOBTITLE='90101T' 
 OR UPR30300.JOBTITLE='90102' 
 OR UPR30300.JOBTITLE='90203' 
 OR UPR30300.JOBTITLE='90203F' 
 OR UPR30300.JOBTITLE='90203P') 
 AND  NOT (UPR30300.PAYROLCD='LIFE' OR UPR30300.PAYROLCD='VEHICL') 
  union all
SELECT        dbo.ContractLaborPay.CHEKDATE, ContractLaborPay.DPRTMNT DEPTDESC, ContractLaborPay.JOBTITLE , ContractLaborPay.UNTSTOPY, ContractLaborPay.UPRTRXAM, UPR40301.DSCRIPTN JOBDESC,
                         ContractLaborPay.PYRLRTYP, ContractLaborPay.PAYROLCD, UPR40300.DSCRIPTN DEPTDESC
FROM            (dbo.ContractLaborPay INNER JOIN UPR40301 ON dbo.ContractLaborPay.JOBTITLE = dbo.UPR40301.JOBTITLE) 
                                      INNER JOIN UPR40300 ON dbo.ContractLaborPay.DPRTMNT = dbo.UPR40300.DEPRTMNT
WHERE  dbo.ContractLaborPay.PYRLRTYP=1 
 AND NOT (dbo.ContractLaborPay.JOBTITLE='12702' 
 OR dbo.ContractLaborPay.JOBTITLE='12703' 
 OR dbo.ContractLaborPay.JOBTITLE='60201' 
 OR dbo.ContractLaborPay.JOBTITLE='60201C' 
 OR dbo.ContractLaborPay.JOBTITLE='60202' 
 OR dbo.ContractLaborPay.JOBTITLE='60300' 
 OR dbo.ContractLaborPay.JOBTITLE='60300F' 
 OR dbo.ContractLaborPay.JOBTITLE='80100' 
 OR dbo.ContractLaborPay.JOBTITLE='80500' 
 OR dbo.ContractLaborPay.JOBTITLE='81000' 
 OR dbo.ContractLaborPay.JOBTITLE='83001' 
 OR dbo.ContractLaborPay.JOBTITLE='83002' 
 OR dbo.ContractLaborPay.JOBTITLE='83500' 
 OR dbo.ContractLaborPay.JOBTITLE='90101' 
 OR dbo.ContractLaborPay.JOBTITLE='90101P' 
 OR dbo.ContractLaborPay.JOBTITLE='90101T' 
 OR dbo.ContractLaborPay.JOBTITLE='90102' 
 OR dbo.ContractLaborPay.JOBTITLE='90203' 
 OR dbo.ContractLaborPay.JOBTITLE='90203F' 
 OR dbo.ContractLaborPay.JOBTITLE='90203P') 
 AND  NOT (dbo.ContractLaborPay.PAYROLCD='LIFE' OR dbo.ContractLaborPay.PAYROLCD='VEHICL') 

*/

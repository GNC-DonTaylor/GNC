--132 SALES ON COMMAND (EXPORT)
--SALES ON COMMAND IT {SPECIAL REPORT FOR TASK AGENT WITH IT ACCESS ONLY}
--25 CHAIN STORE ORDER DUMP (EXPORT)
/* RUNTIME- 18:06	RECORDS:1,288,640
SELECT *
FROM VW_RPT_SALES_ON_COMMAND (NOLOCK)
WHERE TRANSACTIONTYPE = 'I'
---------------------------
AND ALTSHIPFLAG = 'Y'
AND WAREHOUSEID = '10'	--RUNTIME-10=8:51, 20=5:09, 40=2:42
and zonecode = '10.2 Held'
*/
CREATE OR ALTER VIEW [DBO].[VW_RPT_SALES_ON_COMMAND]
AS
SELECT
	OH.RECORDTYPE AS RECORDTYPE, 
	OH.TRANSACTIONTYPE, 
	(SELECT PROFILECODE FROM OMTRANSACTIONDP (NOLOCK) WHERE ROWID = OH.R_PROFILE) AS PROFILECODE, 
	IIF(OH.STAGE = 'N' AND OH.USERDEFINEDCODE_2 = 'RESERVE', 'Y', NULL) AS ISRESERVE,
	OH.STAGE AS STAGE,
	SUBSTRING(DBO.FN_STAGESORT(OH.STAGE,'OM'),4,18) AS STAGENAME,
	OH.USERDEFINEDCODE_2 AS STEP,
	OH.REVIEWSTAGE AS REVIEWSTAGE,
	OH.INVENTORYREVIEW, 
	OH.STATUS,
	CO.COMPANYID,
	CO.NAME AS COMPANYNAME,
	TRIM(WH.IDENTITYID) AS WAREHOUSEID,
	TRIM(WH.NAME) AS WAREHOUSENAME, 
	TRIM(OH.TRANSACTIONNUMBER) AS TRANSACTIONNUMBER,
	CAST(OH.SHIPPINGDATE AS DATE) AS REQUESTDATE,
	OH.SHIPPINGDATE AS REQUESTDATETIME,
	CAST(OH.TRANSACTIONDATE AS DATE) AS TRANSACTIONDATE,
	CAST(OH.INVOICEDATE AS DATE) AS INVOICEDATE,
	CAST(OH.TRANSACTIONDUEDATE AS DATE) AS TRANSACTIONDUEDATE,
	NULLIF(TRIM(CONVERT(VARCHAR(256),OH.COMMENT)),'') AS ORDERSHIPPINGINSTRUCTIONS, 
	IDTERMS.TERMSCODE,
	IDTERMS.DESCRIPTION_1 AS TERMSDESCRIPTION,
	TRIM(VCUST.CUSTOMERIDENTITYID) AS CUSTOMERIDENTITYID,
	TRIM(VCUST.CUSTOMERNAME) AS CUSTOMERNAME, 
	ICUST.USERDEFINEDCODE_8 AS NATIONALACCOUNT,
	TRIM(VCUST.CustomerIDGroup) AS IDGROUP,

	----ALTSHIP FIELDS:
	--(	SELECT ALTID.IDENTITYID FROM IDMASTER ALTID (NOLOCK) 
	--	LEFT JOIN FMDISPATCHOBJECT DO (NOLOCK) ON DO.R_SOURCEID = OH.ROWID
	--	WHERE ALTID.ROWID = DO.R_CONSIGNEE
	--	) AS ALTSHIPCONSIGNEEID, 
	IIF(OH.R_SYNONYMSALTSHIPTO IS NULL, 'N', 'Y') AS ALTSHIPFLAG, 
	TRIM(VCONS.CONSIGNEEIDENTITYID) AS CONSIGNEEIDENTITYID,
	TRIM(VCONS.CONSIGNEENAME) AS CONSIGNEENAME,
	TRIM(ISNULL(ALTSHIP.ADDRESS_1, VCONS.CONSIGNEEADDRESS_1)) AS CONSIGNEEADDRESS_1, 
	TRIM(ISNULL(ALTSHIP.ADDRESS_2, VCONS.CONSIGNEEADDRESS_2)) AS CONSIGNEEADDRESS_2, 
	TRIM(ISNULL(ALTSHIP.CITY, VCONS.CONSIGNEECITY)) AS CONSIGNEECITY, 
	TRIM(ISNULL(ALTSHIP.STATE, VCONS.CONSIGNEESTATE)) AS CONSIGNEESTATE, 
	TRIM(ISNULL(ALTSHIP.ZIP, VCONS.CONSIGNEEZIP)) AS CONSIGNEEZIP, 
	TRIM(ISNULL(ALTSHIP.CITY, VCONS.CONSIGNEECITY)) + ', ' + TRIM(ISNULL(ALTSHIP.STATE, VCONS.CONSIGNEESTATE)) AS CONSIGNEECITYSTATE, 
	TRIM(REPLACE(SUBSTRING(ALTSHIP.COMMENT,1,200),CHAR(13)+CHAR(10), '') ) AS ALTSHIPCOMMENT,	--ALTSHIPCOMMENT 
	NULLIF(LEFT(ACONT.TELEPHONE_1,8)+'-'+RIGHT(ACONT.TELEPHONE_1,4),'-') AS SHIPTOTELEPHONE_1,		--SHIPTOTELEPHONE FOR THE MAIN CONSIGNEE 

	ISNULL(	TRIM(REPLACE(SUBSTRING(ALTSHIP.COMMENT,1,200),CHAR(13)+CHAR(10), '') ),	--ALTSHIPCOMMENT READY TO PRINT 
			NULLIF(LEFT(ACONT.TELEPHONE_1,8)+'-'+RIGHT(ACONT.TELEPHONE_1,4),'-')	--SHIPTOTELEPHONE READY TO PRINT 
		) AS CONSIGNEETELEPHONE_1, --OVERRIDE SHIPTOTELEPHONE WITH ALTSHIPCOMMENT IF IT EXISTS.

	VCONS.ConsigneeUserDefinedReference_2 AS STORENUMBER,
	OH.USERDEFINEDREFERENCE_3 AS ORDEREDBY,
	TRIM(OH.FMTRIPNUMBER) AS TRIPNUMBER,
	OH.FMPUSTOPNUMBER AS STOPNUMBER,
	TRIM(OH.FMTRIPNUMBER) + ' / ' + TRIM(STR(OH.FMPUSTOPNUMBER)) AS TRIPSTOPTEXT,
	--(SELECT DO.SCHEDULEDPICKUPDT FROM FMDISPATCHOBJECT DO (NOLOCK) WHERE DO.R_SOURCEID = OH.ROWID) AS LOADDATE,
	TRIM(PART.IDENTITYID) AS SALESREPID,
	TRIM(PART.NAME) AS SALESREPNAME,
	IIF(OH.R_ZONEFREIGHTRATEOVERRIDE IS NULL, NULL, 'Y') AS ISZONEOVERRIDE,
	TRIM(ZONCOD.CODE) AS ZONECODE,
	TRIM(ZONCOD.DESCRIPTION) AS ZONEDESCRIPTION,
	VCONS.ConsigneeUserDefinedCode_10 AS TAGCODE,
	PSH.PRICESCHEDULECODE,
	PSH.DESCRIPTION AS PRICESCHEDULEDESCRIPTION,
	--THIS REPLACES THE FUNCTIONAL IDEA OF WHAT PRICETYPE ENDED UP BEING USED FOR IN ePLANT:
	IIF(PSD.R_ITEM = OD.R_ITEM, 'Y', NULL) AS ISSCHEDULEDETAIL,
	OH.PURCHASEORDERNUMBER,
	SUBSTRING(PGC.PRODUCTCATEGORYCODE,1,3) AS PLANTGROUPCODE,
	ITM.REFERENCE_5 AS SORTNAMEVARIETY,
	CNT.CONTAINERSORT,
	TRIM(ITM.SUBCLASSCODE) AS QUALITYCODE,
	OD.QUANTITYORDERED,
	OD.QUANTITYSHIPPED, -->REQUESTED TO BE ADDED TO END OF SALES ON COMMAND EXCEL REPORT BY JD - DT 3/17/22
	CNT.CONTAINERCODE,
	CNT.PRINTEDCONTAINERCODE,
	TRIM(LOT.LOTCODE) AS LOTCODE,
	TRIM(LOC.LOCATIONCODE) AS LOCATIONCODE,
		ISNULL(DBO.FN_OMATTRIBUTES(OD.ROWID, IL.ROWID, 'SOURCE'),'') + '.' + 
		ISNULL(DBO.FN_OMATTRIBUTES(OD.ROWID, IL.ROWID, 'DesigCust'),'') + '.' + 
		ISNULL(DBO.FN_OMATTRIBUTES(OD.ROWID, IL.ROWID, 'DesigItem'),'') + '.' + 
		ISNULL(DBO.FN_OMATTRIBUTES(OD.ROWID, IL.ROWID, 'DesigLoc'),'') AS DESCRIPTORCODE,
	TRIM(ITM.ITEMCODE) AS ITEMCODE, 
	ITM.REFERENCE_1 AS COMMONNAME,
	ITM.REFERENCE_2 + ' ' + ISNULL(ITM.USERDEFINEDREFERENCE_1,' ') AS BOTANICALNAME,
	ITM.USERDEFINEDREFERENCE_1 AS PATENTNUMBER,
	ITM.ITEMSUPCCODE,
	ITM.USERDEFINEDCODE_2 AS BRAND,
	--SPECIAL TREATMENT OF TEXT FIELDS
	--IIF(DATALENGTH(ISNULL(PSD.COMMENT,' '))<12,NULL,PSD.COMMENT) AS OVERRIDEUPC,
	--STOLE THIS FROM THE FN_FORMATUPC CODE:
	IIF(DATALENGTH(TRIM(REPLACE(SUBSTRING(PSD.COMMENT,1,14),CHAR(13)+CHAR(10), '') ) )=0,
			NULL, TRIM(REPLACE(SUBSTRING(PSD.COMMENT,1,14),CHAR(13)+CHAR(10), '') ) )
			AS OVERRIDEUPC,
	DBO.FN_FORMATUPC(PSH.ROWID, WH.ROWID, ITM.ROWID) AS FORMATTEDUPC,
	IIF(PSH.SKUREQUIRED='Y', '*', NULL) AS SKUREQMARK,
	IIF(PSH.RETAILREQUIRED='Y', '*', NULL) AS RETAILREQMARK,
	PSD.ALTERNATESKU AS CUSTOMERSKU,
	PSD.RETAILPRICE AS RETAILPRICE,
	LOT.USERDEFINEDCODE_3 AS HOLDSTOPCODE,
	LOT.USERDEFINEDREFERENCE_4 AS HOLDSTOPREASON,
	LOT.USERDEFINEDREFERENCE_7 AS SALESNOTE,
	DBO.FN_SALESNOTE(ITM.ROWID, LOT.ROWID, NULL) AS FNSALESNOTE,
	--These are text datatypes, not compatible with varchar functions:
	IIF(DATALENGTH(ISNULL(OD.COMMENT,' '))<2,NULL,OD.COMMENT) AS PICKNOTE,
	IIF(DATALENGTH(ISNULL(OD.USERDEFINEDCOMMENT,' '))<2,NULL,OD.USERDEFINEDCOMMENT) AS CUSTLINETEXT,
	VCONS.ConsigneeUserDefinedReference_7 AS SHIPPINGNOTES,
	VCONS.ConsigneeComment AS GENERALLOADINSTR,
	VCONS.ConsigneeUserDefinedReference_8 AS OKLOADINSTRUCTIONS, 
	VCONS.ConsigneeUserDefinedReference_9 AS TXLOADINSTRUCTIONS, 
	VCONS.ConsigneeUserDefinedReference_10 AS NCLOADINSTRUCTIONS, 
	VCONS.ConsigneeUserDefinedReference_11 AS HLLOADINSTRUCTIONS, 
--THIS FIELD IS ONLY USED ON THE Chain Store Order Dump EXCEL:
	CASE WH.IDENTITYID
		WHEN 10 THEN VCONS.ConsigneeUserDefinedReference_8
		WHEN 20 THEN VCONS.ConsigneeUserDefinedReference_9
		WHEN 40 THEN VCONS.ConsigneeUserDefinedReference_10
		WHEN 60 THEN VCONS.ConsigneeUserDefinedReference_11
		ELSE NULL
	END AS LOADINSTRUCTIONS, 

/*
	--BAD DATA (DUPLICATE TRIP#) FORCES ME TO USE TOP 1 BUT WRONG PLANSTART COULD BE RETURNED:
		--SELECT * FROM FMTRIPHEADER TH (NOLOCK) WHERE TH.TRIPNO = 'T04075'
		--WHEN TRIP T04075 DUPLICATE HAS BEEN REMOVED, I WILL REMOVE THE TOP 1 CODE SO THE REPORT WILL BOMB IF IT HAPPENS AGAIN.
		--	(SELECT top 1 TH.PLANSTART FROM FMTRIPHEADER TH (NOLOCK) WHERE TH.TRIPNO = OH.FMTRIPNUMBER) AS PLANSTART,
	(SELECT TH.PLANSTART FROM FMTRIPHEADER TH (NOLOCK) WHERE TH.TRIPNO = OH.FMTRIPNUMBER) AS PLANSTART,
	(SELECT TOP 1 TD.SCHEDULEDDELARRIVALDT 
		FROM FMTRIPHEADER TH (NOLOCK) 
		LEFT JOIN FMTRIPDETAIL TD (NOLOCK) ON TD.R_TRIPHEADER = TH.ROWID
		WHERE TH.TRIPNO = OH.FMTRIPNUMBER AND TD.DELSTOPNO = OH.FMPUSTOPNUMBER) AS ESTIMATEDARRIVALDATE,
*/

--Above has been replaced by LEFT JOIN of FMTRIPHEADER TH (the earlier code was not the best way to join the data anyway)
--Duplicate Trip#s will no longer bomb the report, but it will list both Trip Details in the report.	--DT 2/6/24
	ISNULL((SELECT TOP 1 DESCRIPTION_1 FROM FMCODES (NOLOCK) WHERE CODETYPE = '52' AND CODE = TH.USERDEFINEDCODE_2), '') AS DOCK,
	TH.PLANSTART, 
	(SELECT TOP 1 TD.SCHEDULEDDELARRIVALDT 
		FROM FMTRIPDETAIL TD (NOLOCK) 
		WHERE TD.R_TRIPHEADER = TH.ROWID
		AND TD.DELSTOPNO = OH.FMPUSTOPNUMBER) AS ESTIMATEDARRIVALDATE,

	DBO.FN_LISTPRICE(ITM.ROWID,OH.SHIPPINGDATE,IIF(CHARINDEX(OH.STAGE,'A;S;C')>0,OD.QUANTITYSHIPPED,OD.QUANTITYORDERED)) AS LISTPRICE,
	OD.UNITPRICE,
	ISNULL(OD.HANDLINGCHARGEPERITEM,0) AS HANDLINGCHARGEPERITEM,
	ISNULL(OD.TAGGINGCHARGEPERITEM,0) AS TAGGINGCHARGEPERITEM,
	OD.UNITPRICE + ISNULL(OD.HANDLINGCHARGEPERITEM,0) + ISNULL(OD.TAGGINGCHARGEPERITEM,0) AS COMBINEDPRICE,
------------------------------------------------------------------------------------
--Zero FRTZONE amount denotes that FREIGHTRATEPERITEM should be treated as Zero too.
	IIF(ISNULL(DBO.FN_ORDERFREIGHT(OH.ROWID, 'FRTZONE'),0) = 0, 0, ISNULL(OD.FREIGHTRATEPERITEM, 0)) AS FREIGHTRATEPERITEM,
	OD.UNITPRICE + ISNULL(OD.HANDLINGCHARGEPERITEM,0) + ISNULL(OD.TAGGINGCHARGEPERITEM,0) + IIF(ISNULL(DBO.FN_ORDERFREIGHT(OH.ROWID, 'FRTZONE'),0) = 0, 0, ISNULL(OD.FREIGHTRATEPERITEM, 0)) AS LANDED,
------------------------------------------------------------------------------------
	OD.UNITPRICE * IIF(CHARINDEX(OH.STAGE,'A;S;C')>0,OD.QUANTITYSHIPPED,OD.QUANTITYORDERED) AS EXTUNITPRICE,
	DBO.FNOM_CALCULATETRANSTOTALS(OH.ROWID,'OUTTOTALAMOUNT') AS ORDERTOTAL, 
--NEW FIELDS ADDED TO THE END PER TREE - DT 2/26/24
	ITM.PIECESPERUNITQUANTITY AS EQUIV_UNIT, 
	ITM.PIECESPERUNITUOM AS EQUIV_UOM, 
	ITM.USERDEFINEDCODE_19 AS WINGDINGUNITS, 
	(SELECT WEIGHTORDERED FROM FMDISPATCHOBJECT DO (NOLOCK) WHERE DO.TRACKINGNUMBER = OH.TRANSACTIONNUMBER) AS DROPWEIGHT,
	--(	SELECT ISNULL(DO.WEIGHTORDERED,0) 
	--	FROM FMTRIPDETAIL TD (NOLOCK) 
	--	JOIN FMDISPATCHOBJECT DO (NOLOCK) ON DO.ROWID= TD.R_FMDISPATCHOBJECT 
	--	WHERE TD.R_TRIPHEADER = TH.ROWID 
	--	AND DO.TRACKINGNUMBER = OH.TRANSACTIONNUMBER 
	--) AS DROPWEIGHT, 
	LOT.USERDEFINEDREFERENCE_6 AS INTERNALINVNOTE 

FROM OMTRANSACTIONHEADER OH (NOLOCK)
	LEFT OUTER JOIN OMTRANSACTIONDETAIL OD (NOLOCK) ON OD.R_TRANSACTIONHEADER = OH.ROWID
	LEFT JOIN IMTRANSACTIONLOCATION IL (NOLOCK) ON IL.R_TRANSACTIONDETAIL = OD.ROWID
	LEFT JOIN IMLOCATION LOC (NOLOCK) ON LOC.ROWID = IL.R_LOCATION
	LEFT OUTER JOIN IMITEM ITM (NOLOCK) ON ITM.ROWID = OD.R_ITEM
	LEFT OUTER JOIN IMPRODUCTCATEGORY PGC (NOLOCK) ON PGC.ROWID = ITM.R_PRODUCTCATEGORY
	LEFT OUTER JOIN IMCONTAINER CNT (NOLOCK) ON CNT.ROWID = ITM.R_CONTAINERCODE
	LEFT OUTER JOIN IMLOT LOT (NOLOCK) ON LOT.ROWID = OD.R_LOT
	--LEFT OUTER JOIN VW_IDSHIPPERVIEW VWH (NOLOCK) ON VWH.SHIPPERMASTERROWID = OH.R_FMSHIPPER
	LEFT OUTER JOIN VW_IDCUSTOMERVIEW VCUST (NOLOCK) ON VCUST.CUSTOMERMASTERROWID = OH.R_CUSTOMER
	LEFT OUTER JOIN VW_IDCONSIGNEEVIEW VCONS (NOLOCK) ON VCONS.CONSIGNEEMASTERROWID = OH.R_SHIPPER
	LEFT JOIN IDSYNONYMS ALTSHIP (NOLOCK) ON ALTSHIP.ROWID = OH.R_SYNONYMSALTSHIPTO	-->NEW ALTSHIPTOADDRESS PROJECT 3/31/23 DT 
	LEFT JOIN IDADDRESS ACONT (NOLOCK) ON ACONT.R_IDENTITY = DBO.FN_GETCONTACT(VCONS.ConsigneeMasterRowID,'02','C5')
	LEFT OUTER JOIN IDCUSTOMER ICUST (NOLOCK) ON ICUST.R_IDENTITY = OH.R_CUSTOMER
	LEFT OUTER JOIN IDMASTER WH (NOLOCK) ON WH.ROWID = OH.R_FMSHIPPER
	LEFT JOIN IDCONSIGNEESHIPPERZONE SZ (NOLOCK) ON SZ.R_CONSIGNEE = VCONS.ConsigneeMasterRowID AND SZ.R_SHIPPER = WH.ROWID
	LEFT OUTER JOIN IMPRICESCHEDULEHEADER PSH (NOLOCK) ON PSH.ROWID = ISNULL(SZ.R_PRICESCHEDULE, VCONS.CONSIGNEER_PRICESCHEDULE)
	LEFT JOIN IMPRICESCHEDULEDETAIL PSD (NOLOCK) ON PSD.R_PRICESCHEDULEHEADER = PSH.ROWID AND PSD.R_ITEM = OD.R_ITEM AND PSD.EXPIRATIONDATE >= GETDATE()
	LEFT OUTER JOIN RTZONETABLECODES ZONCOD (NOLOCK) ON ZONCOD.ROWID = ISNULL(OH.R_ZONEFREIGHTRATEOVERRIDE,SZ.R_ZONE)
	LEFT OUTER JOIN ABCOMPANY CO (NOLOCK) ON CO.COMPANYID = OH.COMPANYID
	LEFT OUTER JOIN IDADDRESS COADD (NOLOCK) ON COADD.ROWID = CO.R_DEFAULTADDRESS
	LEFT OUTER JOIN IDMASTER PART (NOLOCK) ON PART.ROWID = OH.R_SALESPERSON_1
	LEFT OUTER JOIN IDTERMS (NOLOCK) ON IDTERMS.ROWID = OH.R_TERMS
	LEFT JOIN FMTRIPHEADER TH (NOLOCK) ON OH.FMTRIPNUMBER = TH.TRIPNO
WHERE OH.RECORDTYPE <> 'P' AND OH.TRANSACTIONTYPE = 'I' 
AND	OH.STAGE <> 'L'	--ELIMINATE "CANCELLED" ORDERS.


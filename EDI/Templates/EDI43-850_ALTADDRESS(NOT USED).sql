--EDI43_850_ALTADDRESS (Create Site One 850 Alternate Address Synonym Record)
/*
SELECT ROWID AS ATTACHTOHEADERID, R_IDENTITY, NAME
FROM IDSYNONYMS (NOLOCK) --WHERE ADDRESS_1 IS NOT NULL
WHERE NAME LIKE '823373%'--'Smith'--

ATTACHTOHEADERID						R_IDENTITY								NAME									TRANSACTIONNUMBER
E324C7DC-329C-419C-B92F-0030C88CB8C3	78F254EF-AE6F-48EF-81C6-FF809B8FE63F	boogie                                  10-45735
C546CDFC-06F2-4953-BEE7-236EF9002779	78F254EF-AE6F-48EF-81C6-FF809B8FE63F	Smith                                   
F7AC307C-F279-4BA4-BCC2-773A857A821E	670E9C8F-F561-4C56-AFDC-902E4F743E2D	Pike #19                                
12624B27-B91F-47F4-A8F1-93E1572C72D3	04440ABA-D13B-4047-9134-3FF16D4CE3C3	Zeus                                    
77B6EE0D-04EA-40C4-94DD-1FA8C62A95EE	78F254EF-AE6F-48EF-81C6-FF809B8FE63F	823373                                  
7024A067-46F9-4A2B-B10E-C7B2F8880CF2	6A0F3DBC-7648-4C68-B23B-93B70EF75F4D	823373-1                                
38721099-A160-4653-A637-DB259261D97F	3AC198EC-696F-4724-A313-013E0C9B977E	823373-2                                
5243D692-AD6F-40D7-A89D-DE031B31967C	CA29510B-C1C3-45AE-A78C-75C46AADA747	823373-5                                
*/
DECLARE 

@R_IDENTITY	VARCHAR(38)	= '78F254EF-AE6F-48EF-81C6-FF809B8FE63F', 
@NAME		CHAR(40)	= 'Smith', 
@ADDRESS_1	VARCHAR(40)	= 'Elm st', 
@ADDRESS_2	VARCHAR(40)	= '', 
@CITY		CHAR(30)	= 'smithville', 
@STATE		VARCHAR(5)	= 'TN', 
@ZIP		VARCHAR(15)	= '12345', 
@COUNTRY	VARCHAR(30)	= NULL, 
@PHONE		CHAR(40)	= '(918) 457-5172 x 2267',

@BASENAME	CHAR(40),	
@NEXTID		CHAR(5),	
@NEWNAME	CHAR(40),	
@ROWID		VARCHAR(38)	
SET @ROWID = ( 
	SELECT ROWID 
	FROM IDSYNONYMS (NOLOCK) 
	WHERE R_IDENTITY = @R_IDENTITY 
	AND ISNULL(NAME,'') = ISNULL(@NAME,'') 
	AND ISNULL(ADDRESS_1,'') = ISNULL(@ADDRESS_1,'') 
	AND ISNULL(ADDRESS_2,'') = ISNULL(@ADDRESS_2,'') 
	AND ISNULL(CITY,'') = ISNULL(@CITY,'') 
	AND ISNULL(STATE,'') = ISNULL(@STATE,'') 
	AND ISNULL(ZIP,'') = ISNULL(@ZIP,'') 
	AND ISNULL(COUNTRY,'') = ISNULL(@COUNTRY,'') 
	)
--REMINDER REMINDER REMINDER--
--NEED TO ADD PHONE TO THE MAP OR SET IT TO NULL OR BLANK. DOES PHONE CHANGE CAUSE NEW ADDRESS? THINK THIS THROUGH.

BEGIN 
	--FORCE @NAME TO HAVE A VALUE:
	IF ISNULL(@NAME,'') = '' SET @NAME = 'NONAME'
	--WHAT NAME TO USE IF DUPLICATE NAME FOUND?:
	SET @BASENAME =	(	SELECT IIF(CHARINDEX('-',@NAME)>0, LEFT(@NAME,CHARINDEX('-',@NAME)-1), @NAME))
	SET @NEXTID =	(	SELECT MAX(X.ID)+1 
						FROM(	SELECT	IIF(CHARINDEX('-',NAME)>0, 
										TRIM(STR(CAST(SUBSTRING(NAME, CHARINDEX('-',NAME)+1,40) AS INT))), 
										'0') AS ID 
								FROM IDSYNONYMS (NOLOCK) 
								WHERE NAME LIKE TRIM(@BASENAME) + '%'					--'823373'+'%'
							) X) 
	SET @NEWNAME =	TRIM(@BASENAME) + NULLIF('-' + ISNULL(@NEXTID,''),'-')

	--TEST RESULTS:
	SELECT @ROWID AS ROWID, @NAME AS NAME, @BASENAME AS BASENAME, @NEXTID AS NEXTID, @NEWNAME AS NEWNAME

	--TEST ACTIONS:
	SELECT IIF( @ROWID IS NULL, 'CREATE '+ISNULL(@NEWNAME, @NAME), 'ATTACH '+@NAME)

	IF @ROWID IS NULL 
		BEGIN
			SET @ROWID = '00000000-0000-0000-0000-000000000000'--NEWID() 

--INSERT COMMAND TURNED OFF UNTIL I WANT TO TEST THE CODE (FIX PHONE FIRST)
--
--			INSERT INTO IDSYNONYMS
			SELECT 
				@ROWID AS ROWID, 
				'SB' AS COMPANYID, 
				'ID' AS MODULE, 
				'R' AS RECORDTYPE, 
				@R_IDENTITY AS R_IDENTITY, 
				'02' AS IDTYPE, 
				ISNULL(@NEWNAME, @NAME) AS NAME, 
				@ADDRESS_1 AS ADDRESS_1, 
				@ADDRESS_2 AS ADDRESS_2,
				@CITY AS CITY, 
				@STATE AS STATE, 
				@ZIP AS ZIP, 
				@COUNTRY AS COUNTRY, 
				@PHONE AS COMMENT,
				NULL AS R_EDIHEADER, 
				NULL AS USERDEFINEDCODE_1
		END
	SELECT @ROWID AS ROWID
END

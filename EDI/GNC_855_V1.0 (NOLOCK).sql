DECLARE @ROWID UNIQUEIDENTIFIER
SET @ROWID= '0690A11A-EAE6-4E30-9FCE-18ABB1E018AB'
--'A7365D48-D851-4343-B663-8E72995EF12E'
--B36E38AD-FC84-49E4-B172-9A328CB88E93'
--'628274A8-B00D-471E-B493-3350653D7E66'
--'254D3F8E-2481-42E2-8AF1-0B3996C7C83A'
--'7E54C69F-3AA5-42F0-A5B7-1349D16DBB2F'
--'BED3E2ED-2188-489C-A814-30594AC8EA4A'
--'1FEE9D26-9E8D-4B00-A270-553AA18ED4C2'
--'2DFBB684-7434-42E6-B129-588D606205E2'
--'C48C60ED-9DDC-4C30-8201-59F6F3B3DE30'
--'3259336C-90E9-4853-BA99-68BBAA83E3C9'
--'BAB72D3B-3407-4A59-99E7-70C002345675'
--'1053BF37-FA4A-4D81-9FBB-745620EA7A9E'
--'5B072D97-BFAA-4748-A488-76FF7E522EA0'
--'B37C3F31-646C-4F11-B93D-833FEBCA062D'
--'D51091AD-59C0-4113-8285-83A688EFA128'
--'35A26CC3-79A7-4ACD-873E-850D2510D40A'
--'A72EA4FC-51EB-42B3-BC1D-99833FB33727'
--'4343FE6A-CBE5-40D5-8664-9A46F7DFAAAD'
--'7E29C272-55CD-4F7F-A53B-C8F9D7781E1A'
--'293987D4-59A4-4D3E-AC61-CF7ECFA221CE'
--'294E98B8-6A1F-459D-B1AC-D521C938648C'
--'6C00E947-865C-43BC-A02D-DC2A8BDAEE2F'
--'AB9D9F3C-F84F-46AD-A18F-E6954BC9D208'
--'7EDFFC05-FF20-43AC-AFB8-50836215094E'

--GNC_855_V1.0 (NOLOCK)
--HEADER RECORD:
SELECT 'HDR' AS RECTYPE,
IIF(OH.STAGE='L','CA',IIF(OH.EDITRANSMITFLAG='Y','CH','PO')) AS TRTYPE,
--LEFT(ISNULL(CUST.IDGROUP,'')+SPACE(4),4) AS IDGROUP,
LEFT(ISNULL(OH.USERDEFINEDREFERENCE_5,'')+SPACE(4),4) AS IDGROUP,
LEFT(ISNULL(OH.PURCHASEORDERNUMBER,'')+SPACE(20),20) AS PO,
FORMAT(OH.TRANSACTIONDATE ,'yyyyMMdd') AS PODATE,
LEFT(OH.USERDEFINEDREFERENCE_4+SPACE(15),15) AS WRKNO,
LEFT(OH.USERDEFINEDREFERENCE_4+SPACE(30),30) AS ORDBY,
FORMAT(OH.SHIPPINGDATE ,'yyyyMMdd') AS REQSDT,
LEFT(ISNULL(CONS.USERDEFINEDREFERENCE_2,'')+SPACE(20),20) AS STORE,
LEFT(ISNULL(OH.TRANSACTIONNUMBER,'')+SPACE(15),15) AS ORDNO,
LEFT(ISNULL(WH.IDENTITYID,'')+SPACE(2),2) AS BRPL
FROM OMTRANSACTIONHEADER OH (NOLOCK)
LEFT JOIN IDMASTER CUST (NOLOCK) ON CUST.ROWID = OH.R_SHIPPER
LEFT JOIN IDMASTER WH (NOLOCK) ON WH.ROWID = OH.R_FMSHIPPER
LEFT JOIN IDCONSIGNEE CONS (NOLOCK) ON CONS.R_IDENTITY=OH.R_SHIPPER
WHERE OH.ROWID=@ROWID AND (ISNULL(OH.INVENTORYREVIEW,'') <> 'Y' OR OH.STAGE='L')


--DETAIL RECORD:
SELECT 'DTL' AS RECTYPE, 
MAX(IIF(OH.STAGE='L','CA',IIF(OH.EDITRANSMITFLAG='Y','CH','PO'))) AS TRTYPE, 
--MAX(LEFT(ISNULL(CUST.IDGROUP,'')+SPACE(4),4)) AS IDGROUP, 
MAX(LEFT(ISNULL(OH.USERDEFINEDREFERENCE_5,'')+SPACE(4),4)) AS IDGROUP, 
MAX(LEFT(ISNULL(OH.PURCHASEORDERNUMBER,'')+SPACE(20),20)) AS PO, 
MAX(LEFT(OH.USERDEFINEDREFERENCE_4+SPACE(15),15)) AS WRKNO, 
LEFT(ISNULL(PSD.ALTERNATESKU,'')+SPACE(25),25) AS SKUCODE, 
MAX(LEFT(RIGHT('00'+ISNULL(NULLIF(TRIM(REPLACE(SUBSTRING(PSD.COMMENT,1,14),CHAR(13)+CHAR(10), '')), ''),ITM.ITEMSUPCCODE),12)+SPACE(12),12)) AS UPCNO,
MAX(STR(ISNULL(OD.UNITPRICE,0) + 
		ISNULL(OD.HANDLINGCHARGEPERITEM,0) + 
		ISNULL(OD.TAGGINGCHARGEPERITEM,0) + 
		IIF(ISNULL(DBO.FN_ORDERFREIGHT(OH.ROWID, 'FRTZONE'),0) = 0, 0, ISNULL(OD.FREIGHTRATEPERITEM, 0)),12,2)) AS PRICE, 
		--ISNULL(OD.FREIGHTRATEPERITEM,0),12,2)) AS PRICE, 
STR(SUM(IIF(CHARINDEX(OH.STAGE,'A;S;C')>0,ISNULL(OD.QUANTITYSHIPPED,0),ISNULL(OD.QUANTITYORDERED,0))),7,0) AS QTYORD, 
MAX(LEFT(ISNULL(ITM.ITEMCODE,'')+SPACE(12),12)) AS ITEMNO, 
MAX(LEFT(ISNULL(OH.TRANSACTIONNUMBER,'')+SPACE(15),15)) AS ORDNO 
FROM OMTRANSACTIONHEADER OH (NOLOCK) 
LEFT JOIN OMTRANSACTIONDETAIL OD (NOLOCK) on OD.R_TRANSACTIONHEADER=OH.ROWID
LEFT JOIN IMITEM ITM (NOLOCK) ON ITM.ROWID = OD.R_ITEM
LEFT JOIN IDMASTER CUST (NOLOCK) ON CUST.ROWID = OH.R_CUSTOMER
LEFT JOIN IDCUSTOMER ICUST (NOLOCK) ON ICUST.R_IDENTITY = OH.R_CUSTOMER
LEFT JOIN IDMASTER WH (NOLOCK) ON WH.ROWID = OD.R_WAREHOUSE
LEFT JOIN IDCONSIGNEE CONS (NOLOCK) ON CONS.R_IDENTITY = OH.R_SHIPPER
LEFT JOIN IDCONSIGNEESHIPPERZONE SZ (NOLOCK) ON SZ.R_CONSIGNEE = CONS.R_IDENTITY AND SZ.R_SHIPPER = WH.ROWID
LEFT JOIN IMPRICESCHEDULEDETAIL PSD (NOLOCK) ON PSD.R_PRICESCHEDULEHEADER = ISNULL(SZ.R_PRICESCHEDULE, CONS.R_PRICESCHEDULE) 
AND PSD.R_ITEM = OD.R_ITEM AND PSD.EXPIRATIONDATE >= GETDATE()
WHERE OD.R_TRANSACTIONHEADER = @ROWID 
AND ISNULL(ICUST.USERDEFINEDCODE_3,'') ='Y' 
AND (ISNULL(OH.INVENTORYREVIEW,'') <> 'Y' OR OH.STAGE='L')
AND (	SELECT IDMASTER.IDSUBGROUP FROM IDMASTER (NOLOCK)
		WHERE IDMASTER.ROWID = CAST(OH.USERDEFINEDREFERENCE_10 AS UNIQUEIDENTIFIER) 
	) = 'LEGACY'
GROUP BY PSD.ALTERNATESKU

UNION ALL

SELECT  'DTL' AS RECTYPE, 
IIF(OH.STAGE='L','CA',IIF(OH.EDITRANSMITFLAG='Y','CH','PO')) AS TRTYPE, 
--LEFT(ISNULL(CUST.IDGROUP,'')+SPACE(4),4) AS IDGROUP, 
LEFT(ISNULL(OH.USERDEFINEDREFERENCE_5,'')+SPACE(4),4) AS IDGROUP, 
LEFT(ISNULL(OH.PURCHASEORDERNUMBER,'')+SPACE(20),20) AS PO, 
LEFT(OH.USERDEFINEDREFERENCE_4+SPACE(15),15) AS WRKNO, 
LEFT(ISNULL(PSD.ALTERNATESKU,'')+SPACE(25),25) AS SKUCODE, 
LEFT(RIGHT('00'+ISNULL(NULLIF(TRIM(REPLACE(SUBSTRING(PSD.COMMENT,1,14),CHAR(13)+CHAR(10), '')), ''),ITM.ITEMSUPCCODE),12)+SPACE(12),12) AS UPCNO,
STR(ISNULL(OD.UNITPRICE,0) + 
	ISNULL(OD.HANDLINGCHARGEPERITEM,0) + 
	ISNULL(OD.TAGGINGCHARGEPERITEM,0) + 
	IIF(ISNULL(DBO.FN_ORDERFREIGHT(OH.ROWID, 'FRTZONE'),0) = 0, 0, ISNULL(OD.FREIGHTRATEPERITEM, 0)),12,2) AS PRICE, 
	--ISNULL(OD.FREIGHTRATEPERITEM,0),12,2) AS PRICE, 
STR(IIF(CHARINDEX(OH.STAGE,'A;S;C')>0,ISNULL(OD.QUANTITYSHIPPED,0),ISNULL(OD.QUANTITYORDERED,0)),7,0) AS QTYORD, 
LEFT(ITM.ITEMCODE+SPACE(12),12) AS ITEMNO, 
LEFT(ISNULL(OH.TRANSACTIONNUMBER,'')+SPACE(15),15) AS ORDNO 
FROM OMTRANSACTIONHEADER OH (NOLOCK) 
LEFT JOIN OMTRANSACTIONDETAIL OD (NOLOCK) on OD.R_TRANSACTIONHEADER=OH.ROWID
LEFT JOIN IMITEM ITM (NOLOCK) ON ITM.ROWID = OD.R_ITEM
LEFT JOIN IDMASTER CUST (NOLOCK) ON CUST.ROWID = OH.R_CUSTOMER
LEFT JOIN IDCUSTOMER ICUST (NOLOCK) ON ICUST.R_IDENTITY = OH.R_CUSTOMER
LEFT JOIN IDMASTER WH (NOLOCK) ON WH.ROWID = OD.R_WAREHOUSE
LEFT JOIN IDCONSIGNEE CONS (NOLOCK) ON CONS.R_IDENTITY = OH.R_SHIPPER
LEFT JOIN IDCONSIGNEESHIPPERZONE SZ (NOLOCK) ON SZ.R_CONSIGNEE = CONS.R_IDENTITY AND SZ.R_SHIPPER = WH.ROWID
LEFT JOIN IMPRICESCHEDULEDETAIL PSD (NOLOCK) ON PSD.R_PRICESCHEDULEHEADER = ISNULL(SZ.R_PRICESCHEDULE, CONS.R_PRICESCHEDULE) 
AND PSD.R_ITEM = OD.R_ITEM AND PSD.EXPIRATIONDATE >= GETDATE()
WHERE OD.R_TRANSACTIONHEADER = @ROWID 
AND ISNULL(ICUST.USERDEFINEDCODE_3,'') <> 'Y' 
AND (ISNULL(OH.INVENTORYREVIEW,'') <> 'Y' OR OH.STAGE='L')
AND (	SELECT IDMASTER.IDSUBGROUP FROM IDMASTER (NOLOCK)
		WHERE IDMASTER.ROWID = CAST(OH.USERDEFINEDREFERENCE_10 AS UNIQUEIDENTIFIER) 
	) = 'LEGACY'


------------------------------
-- FUNCTION: FN_FORMATUPC(PSROWID[NULL],WHROWID,ITEMROWID)
------------------------------
-- RETURNS THE FORMATTED UPC OF THE PRICESCHEDULE ROWID AND ITEM ROWID PASSED TO IT
-- 1. IF PSROWID IS PASSED AS NULL, IT WILL RETURN THE DEFAULT ITEM UPCCODE.
-- 2. IF PSROWID IS INCLUDED IT FIRST ATTEMPTS TO RETURN THE PRICE SCHEDULE'S UPC, 
--    THEN IF NOT FOUND, IT RETURNS THE DEFAULT ITEM UPCCODE.
-- IF IT FINDS NEITHER, THE NULL VALUE IS RETURNED.
------------------------------
-- DON TAYLOR @ 09/23/2020
------------------------------
CREATE OR ALTER FUNCTION [DBO].[FN_FORMATUPC]
(	@PSROWID UNIQUEIDENTIFIER,
	@WHROWID UNIQUEIDENTIFIER,
	@ITEMROWID UNIQUEIDENTIFIER
)	RETURNS VARCHAR(15)
AS
BEGIN
	DECLARE @RESULT VARCHAR(15)
	DECLARE @RAWUPC VARCHAR(12)
	SET @RAWUPC = 'NOT NULL'
	IF @PSROWID IS NOT NULL 
	BEGIN
		IF @WHROWID IS NULL 
			RETURN NULL
		IF @ITEMROWID IS NULL 
			RETURN NULL
		SET @RAWUPC = 
			(
			--PSC.COMMENT is a TEXT field, so test for both DATALENGTH and ISNULL to get correct results:
			--SELECT RIGHT('00'+TRIM(SUBSTRING(IIF(DATALENGTH(ISNULL(PSD.COMMENT,' '))<12,ITM.ITEMSUPCCODE,PSD.COMMENT),1,20)),12)
			--SELECT RIGHT('00'+ISNULL(TRIM(REPLACE(SUBSTRING(PSD.COMMENT,1,14),CHAR(13)+CHAR(10), '')),ITM.ITEMSUPCCODE),12)
			--ADD TOP 1 TO PREVENT BAD DATA FROM HOLDING UP TASK AGENT JOB TO AUTO FAX ACKNOWLEDGEMENTS PER JOANNE
			SELECT TOP 1 RIGHT('00'+IIF(	DATALENGTH(TRIM(REPLACE(SUBSTRING(PSD.COMMENT,1,14),CHAR(13)+CHAR(10), '') ) )=0,
									ITM.ITEMSUPCCODE,
									TRIM(REPLACE(SUBSTRING(PSD.COMMENT,1,14),CHAR(13)+CHAR(10), '') ) )
									,12)
			FROM IMITEM ITM (NOLOCK) 
			LEFT JOIN IMPRICESCHEDULEDETAIL PSD (NOLOCK) 
				ON PSD.R_PRICESCHEDULEHEADER = @PSROWID 
				AND PSD.R_ITEM = ITM.ROWID 
				AND PSD.EXPIRATIONDATE >= GETDATE()
			WHERE ITM.R_WAREHOUSE = @WHROWID AND ITM.ROWID = @ITEMROWID
			)
		IF @RAWUPC = '00'
			RETURN NULL
	END
	IF (@PSROWID IS NULL OR @RAWUPC IS NULL)
	BEGIN
		SET @RAWUPC = 
			(
			SELECT RIGHT('00'+ITM.ITEMSUPCCODE,12) FROM IMITEM ITM (NOLOCK)
			WHERE ITM.R_WAREHOUSE = @WHROWID AND ITM.ROWID = @ITEMROWID
			)
	END
	SET @RESULT =
		(
			SELECT	SUBSTRING(@RAWUPC,1,1) + '-' 
				+	SUBSTRING(@RAWUPC,2,5) + '-' 
				+	SUBSTRING(@RAWUPC,7,5) + '-' 
				+	SUBSTRING(@RAWUPC,12,1)
		)
	RETURN @RESULT
END
/*	TEST DATA TO DETERMINE WHAT HAPPENS IN EDGE CASES LIKE NULL PSD.ROWID OR NULL PSD.COMMENT:
DBO.FN_FORMATUPC(PSDROWID,WHROWID,ITMROWID) TEST VALUES:
860BE759-FC16-414D-87BB-3A44B6FB05A7	CD6F1D1C-00F9-49F7-9689-C340C484E195	E2D67716-E86A-413A-B98B-8453C520704D
NULL									4E1CB3D5-08A1-4084-89FF-4E0ED538EEA2	B8ADF95A-149B-40CC-8648-98DCBB82BF5D
select dbo.fn_formatupc('860BE759-FC16-414D-87BB-3A44B6FB05A7','CD6F1D1C-00F9-49F7-9689-C340C484E195','E2D67716-E86A-413A-B98B-8453C520704D')
select dbo.fn_formatupc(null,'4E1CB3D5-08A1-4084-89FF-4E0ED538EEA2','B8ADF95A-149B-40CC-8648-98DCBB82BF5D')

			SELECT RIGHT('00'+IIF(	DATALENGTH(TRIM(REPLACE(SUBSTRING(PSD.COMMENT,1,14),CHAR(13)+CHAR(10), '') ) )=0,
									ITM.ITEMSUPCCODE,
									TRIM(REPLACE(SUBSTRING(PSD.COMMENT,1,14),CHAR(13)+CHAR(10), '') ) )
									,12), PSD.COMMENT, ITM.ITEMSUPCCODE
			FROM IMITEM ITM (NOLOCK) 
			LEFT JOIN IMPRICESCHEDULEDETAIL PSD (NOLOCK) 
				ON PSD.R_PRICESCHEDULEHEADER = '860BE759-FC16-414D-87BB-3A44B6FB05A7' 
				AND PSD.R_ITEM = ITM.ROWID 
				AND PSD.EXPIRATIONDATE >= GETDATE()
			WHERE ITM.R_WAREHOUSE = 'CD6F1D1C-00F9-49F7-9689-C340C484E195' AND ITM.ROWID = 'E2D67716-E86A-413A-B98B-8453C520704D'


*/